<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Clustering</title>
<style type="text/css">
/**
 * Prism.s theme ported from highlight.js's xcode style
 */
pre code {
  padding: 1em;
}
.token.comment {
  color: #007400;
}
.token.punctuation {
  color: #999;
}
.token.tag,
.token.selector {
  color: #aa0d91;
}
.token.boolean,
.token.number,
.token.constant,
.token.symbol {
  color: #1c00cf;
}
.token.property,
.token.attr-name,
.token.string,
.token.char,
.token.builtin {
  color: #c41a16;
}
.token.inserted {
  background-color: #ccffd8;
}
.token.deleted {
  background-color: #ffebe9;
}
.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
}
.token.atrule,
.token.attr-value,
.token.keyword {
  color: #836c28;
}
.token.function,
.token.class-name {
  color: #DD4A68;
}
.token.regex,
.token.important,
.token.variable {
  color: #5c2699;
}
.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}
</style>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
</head>
<body>
<div class="include-before">
</div>
<div class="frontmatter">
<div class="title"><h1>Clustering</h1></div>
<div class="author"><h2></h2></div>
<div class="date"><h3></h3></div>
</div>
<div class="body">
<p>To gain more insights into a tissues composition the clustering function can be applied. It is possible to cluster by expression values, deconvolution results or pathway and transcription factor activities.</p>
<pre><code class="language-r">library(spacedeconv)
#&gt; → checking spacedeconv environment and dependencies
library(SpatialExperiment)
#&gt; Lade nötiges Paket: SingleCellExperiment
#&gt; Lade nötiges Paket: SummarizedExperiment
#&gt; Lade nötiges Paket: MatrixGenerics
#&gt; Lade nötiges Paket: matrixStats
#&gt; 
#&gt; Attache Paket: 'MatrixGenerics'
#&gt; Die folgenden Objekte sind maskiert von 'package:matrixStats':
#&gt; 
#&gt;     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
#&gt;     colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
#&gt;     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
#&gt;     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
#&gt;     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
#&gt;     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
#&gt;     colWeightedMeans, colWeightedMedians, colWeightedSds,
#&gt;     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
#&gt;     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
#&gt;     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
#&gt;     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
#&gt;     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
#&gt;     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
#&gt;     rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
#&gt;     rowWeightedSds, rowWeightedVars
#&gt; Lade nötiges Paket: GenomicRanges
#&gt; Lade nötiges Paket: stats4
#&gt; Lade nötiges Paket: BiocGenerics
#&gt; 
#&gt; Attache Paket: 'BiocGenerics'
#&gt; Das folgende Objekt ist maskiert 'package:spacedeconv':
#&gt; 
#&gt;     normalize
#&gt; Die folgenden Objekte sind maskiert von 'package:stats':
#&gt; 
#&gt;     IQR, mad, sd, var, xtabs
#&gt; Die folgenden Objekte sind maskiert von 'package:base':
#&gt; 
#&gt;     anyDuplicated, append, as.data.frame, basename, cbind, colnames,
#&gt;     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,
#&gt;     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,
#&gt;     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
#&gt;     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,
#&gt;     union, unique, unsplit, which.max, which.min
#&gt; Lade nötiges Paket: S4Vectors
#&gt; 
#&gt; Attache Paket: 'S4Vectors'
#&gt; Die folgenden Objekte sind maskiert von 'package:base':
#&gt; 
#&gt;     expand.grid, I, unname
#&gt; Lade nötiges Paket: IRanges
#&gt; Lade nötiges Paket: GenomeInfoDb
#&gt; Lade nötiges Paket: Biobase
#&gt; Welcome to Bioconductor
#&gt; 
#&gt;     Vignettes contain introductory material; view with
#&gt;     'browseVignettes()'. To cite Bioconductor, see
#&gt;     'citation(&quot;Biobase&quot;)', and for packages 'citation(&quot;pkgname&quot;)'.
#&gt; 
#&gt; Attache Paket: 'Biobase'
#&gt; Das folgende Objekt ist maskiert 'package:MatrixGenerics':
#&gt; 
#&gt;     rowMedians
#&gt; Die folgenden Objekte sind maskiert von 'package:matrixStats':
#&gt; 
#&gt;     anyMissing, rowMedians

data(&quot;single_cell_data_3&quot;)
data(&quot;spatial_data_3&quot;)
</code></pre>
<pre><code class="language-r">single_cell_data_3 &lt;- spacedeconv::preprocess(single_cell_data_3)
spatial_data_3 &lt;- spacedeconv::preprocess(spatial_data_3)

single_cell_data_3 &lt;- spacedeconv::normalize(single_cell_data_3, method = &quot;cpm&quot;)
spatial_data_3 &lt;- spacedeconv::normalize(spatial_data_3, method = &quot;cpm&quot;)
deconv &lt;- deconvolute(spe, method = &quot;epic&quot;, assay_sc = &quot;cpm&quot;)
</code></pre>
<pre><code class="language-r">signature &lt;- spacedeconv::build_model(
  single_cell_obj = single_cell_data_3,
  cell_type_col = &quot;celltype_major&quot;,
  method = &quot;dwls&quot;, verbose = T, dwls_method = &quot;mast_optimized&quot;, ncores = 10
)
</code></pre>
<pre><code class="language-r">deconv &lt;- spacedeconv::deconvolute(
  spatial_obj = spatial_data_3,
  single_cell_obj = single_cell_data_3,
  cell_type_col = &quot;celltype_major&quot;,
  method = &quot;dwls&quot;,
  signature = signature,
  assay_sp = &quot;cpm&quot;
)
</code></pre>
<p>First we show how to cluster deconvolution data. Set the data parameter to “deconvolution” and provide the deconvolution tool you used. You can further set the following parameters:</p>
<ul>
<li>nclusters: Number of clusters you want, can be a range</li>
<li>spmethod: should be the deconvolution tool used, or progeny/dorothea when clustering decoupleR results</li>
<li>method: kmeans or hclust</li>
<li>dist_method: for hclust, which distance method to use (“correlation”, “euclidean”, “maximum”, “manhattan”, “canberra”, “binary”, “minkowski”)</li>
<li>hclust_method: for hclust, agglomeration method to us (“complete”, “ward.D”, “ward.D2”, “single”, “average”, “mcquitty”, “median”, “centroid”)</li>
</ul>
<p>This function applies the Seurat clustering approach in the background. Set data to “expression”, this will use “counts” values for clustering. You can further set the following parameters:</p>
<ul>
<li>clusres: Cluster resolution, check the <a href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html">Seurat Vignette</a> for details.</li>
<li>pca_dim: Number of PCA dimensions to use</li>
</ul>
<pre><code class="language-r">cluster &lt;- spacedeconv::cluster(deconv, data = &quot;expression&quot;, clusres = 0.5)
</code></pre>
<pre><code class="language-r">cluster &lt;- readRDS(system.file(&quot;extdata&quot;, &quot;cluster.rds&quot;, package = &quot;spacedeconv&quot;))
</code></pre>
<pre><code class="language-r">plot_celltype(cluster, &quot;cluster&quot;, density = F) # plot the clustering stored in this object
</code></pre>
<p>With an available clustering you can exract the top features for each cluster. Here we extract the top features for each cluster based on expression, but we want the top features from the deconvolution results from this area. See the associated clusters in the plot above.</p>
<pre><code class="language-r">get_cluster_features(cluster, clusterid = &quot;cluster_expression_0.5&quot;, spmethod = &quot;dwls&quot;)
#&gt; $`0`
#&gt; dwls_Cancer.Epithelial               dwls_PVL           dwls_B.cells 
#&gt;             1.48622765            -0.09684142            -0.20176392 
#&gt; 
#&gt; $`1`
#&gt;     dwls_T.cells dwls_Endothelial         dwls_PVL 
#&gt;        0.7706055        0.6349723        0.5992391 
#&gt; 
#&gt; $`2`
#&gt;              dwls_CAFs dwls_Normal.Epithelial       dwls_Endothelial 
#&gt;              0.8553145              0.4136625              0.3882446 
#&gt; 
#&gt; $`3`
#&gt;      dwls_Myeloid dwls_Plasmablasts         dwls_CAFs 
#&gt;         1.4167673         1.0846283         0.6236146 
#&gt; 
#&gt; $`4`
#&gt; dwls_Normal.Epithelial               dwls_PVL       dwls_Endothelial 
#&gt;             2.02138850             0.08999605            -0.05634981 
#&gt; 
#&gt; $`5`
#&gt; dwls_Cancer.Epithelial           dwls_Myeloid           dwls_T.cells 
#&gt;             0.83406399             0.72173387             0.06103056
</code></pre>
</div>
<div class="include-after">
</div>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
</body>
</html>
